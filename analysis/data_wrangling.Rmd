---
title: "Data Wrangling-GIS already completed"
author: "Randy Swaty"
date: "2023-06-09"
output:
  workflowr::wflow_html:
    toc: true
    toc_depth: 3
    code_folding: show
editor_options:
  chunk_output_type: console
---

## Introduction

This page focuses on working with data attribute table exported from ArGIS Pro.  Using data from our example landscape we will:

* read in reference conditions data which originated with the LANDFIRE program.  This dataset has the modeled 'reference' amounts of each succession class for each Biophysical Setting. 
* read in succession class data from a combine of BpS and Succession Class data which originated with LANDFIRE, and in this case has an additional field representing USFS Land Types (more on that below).  This will represent 'current' conditions as mapped by LANDFIRE. 
* read in succession class data generated by the Sclass Mapping Tool.  This is valuable if you have custom sclass rules or input (e.g., vegetation height) data. 
* wrangle reference with current and visualize. 

*Note: your specific output attribute table from ArcGIS might be different.*

## Reading in, wrangling and exploring the input datasets


```{r load packages and read in data, message=FALSE, warning=FALSE}

# load packages
library(janitor)
library(kableExtra)
library(tidyverse)

# read in data

# modified LANDFIRE reference conditions (modifications to format only, completed in Excel)
ref_con_conus <- read_csv("data/ref_con_long.csv")
# local bps data with added USFS Land Types 
bps_aoi <- read_csv("data/bps_with_lts.csv") 
# local bps and sclass data already combined in ArcGIS pro using 'Combine' tool, followed by joining relevant fields using 'Join Field' tool
lf_bps_scls_aoi <- read_csv("data/lf_bps_scls.csv") 
# local bps and custom succession class data.  Sclass data created using the LANDFIRE Sclass tool.  
sclass_tool_output_aoi <- read_csv("data/all_combine_lts.csv")


# clean up column names as needed using janitor package
bps_aoi <- clean_names(bps_aoi)
lf_bps_scls_aoi <- clean_names(lf_bps_scls_aoi)
sclass_tool_output_aoi <- clean_names(sclass_tool_output_aoi)

```


### Reference conditions data for CONUS

Has reference condition percents for all BpSs and Sclasses for the Coterminous United States (CONUS)


```{r, message=FALSE, warning=FALSE}

# display data
kable(ref_con_conus) %>%
  kable_styling(
    font_size = 12,
    bootstrap_options = c("striped", "hover", "condensed")
  ) %>%
  kableExtra::scroll_box(width = "100%", height = "300px")
```


### Reference conditions for Area of Interest (removed extra columns for later joining)

```{r, message=FALSE, warning=FALSE}
aoi_bps_models <- bps_aoi$bps_model

#subset ref_con to aoi included for postarity...unnecessary as joining later removes unwanted BpSs
aoi_ref_con <- subset(ref_con_conus, model_code %in% aoi_bps_models) %>%
  select(model_label, ref_percent)

# display data
kable(aoi_ref_con) %>%
  kable_styling(
    font_size = 12,
    bootstrap_options = c("striped", "hover", "condensed")
  ) %>%
  kableExtra::scroll_box(width = "100%", height = "300px")
```



### Biophysical Settings plus USFS Land Types

Used to bring in Land Type information

```{r, message=FALSE, warning=FALSE}

# display data
kable(bps_aoi) %>%
  kable_styling(
    font_size = 12,
    bootstrap_options = c("striped", "hover", "condensed")
  ) %>%
  kableExtra::scroll_box(width = "100%", height = "300px")
```

<br>

### LANDFIRE BpS and Sclass data combined for AoI

For a basic LANDFIRE-data focused assessment/characterization.  Just need to join in Land Type data and concatenate the bps_model and sclass labels for future joining to reference conditions to make this complete.


```{r , message=FALSE, warning=FALSE}

## wrangle to create dataframe with current and reference percentages, and limit to area of interest

# Perform a left join on lf_bps_scls_aoi and select columns from bps_aoi based on bps_model
lf_bps_scls_aoi <- left_join(lf_bps_scls_aoi,
                             select(bps_aoi, land_type, bps_model), 
                             by = "bps_model") %>%   
# Combine bps_model and label into a new column called model_label  
                    unite(model_label, c("bps_model", "label"), remove = FALSE) %>% 
# Perform a left join on aoi_ref_con based on model_label
                    left_join(aoi_ref_con, by = "model_label") %>% 
# Group the data by bps_model
                    group_by(bps_model) %>%
# Calculate the percentage of each count within its group and round it
                    mutate(cur_percent = round(count/sum(count)*100, )) %>%
# Calculate sum of count per group for later selecting 
                    mutate(bps_model_count = sum(count)) %>%
# Remove the grouping information
                    ungroup()  %>%
# Select specific columns in the desired order
                    select("bps_model", 
                           "bps_name", 
                           'land_type',
                           'bps_model_count',
                           'label',
                           "ref_percent", 
                           "cur_percent") %>%
# Reshape the data from wide to long format
                    pivot_longer(
                    cols = c(`ref_percent`, `cur_percent`), 
                    names_to = "ref_cur", 
                    values_to = "percent"
                    )

# display data
kable(lf_bps_scls_aoi) %>%
  kable_styling(
    font_size = 12,
    bootstrap_options = c("striped", "hover", "condensed")
  ) %>%
  kableExtra::scroll_box(width = "100%", height = "300px")
```


### Sclass tool output

For when you have custom inputs to drive succession class mapping.  In this example we did not, but the outputs would look the same.

```{r}
# display data
kable(sclass_tool_output_aoi) %>%
  kable_styling(
    font_size = 12,
    bootstrap_options = c("striped", "hover", "condensed")
  ) %>%
  kableExtra::scroll_box(width = "100%", height = "300px")
```

<br>

## Visualizing

Below we will present a few ways of presenting succession class charts.


### With base LANDFIRE inputs (*lf_bps_scls_aoi* dataframe), looking at LANDFIRE BpSs first, then crosswalked Land Types.  

For this chart we do a litte more wrangling and formatting to:

* add BpS Name and Model Number to chart
* select topmost 6 BpS models for the landscape
* order succession classes


```{r, message=FALSE, warning=FALSE, fig.width=10, fig.height=9}

## note-there may be multiple BpS names due to multiple Map Zone variants for landscapes that contain multiple LANDFIRE Map Zones. See map at https://landfirereview.org/IMG/USmapzones-v1_July2015.jpg

####  need to limit!
####  watch out for field name changes!

# filter dataset to top 6 BpS Models (note, you may want to filter by name....), then add column with bps model and name for legend

lf_bps_scls_aoi_6 <- lf_bps_scls_aoi %>%
                        dplyr::filter(dense_rank(desc(bps_model_count)) < 7) %>%
                        mutate(bps_model = paste0("(", bps_model, ")")) %>%
                        unite(model_label, c("bps_name", "bps_model"), remove = FALSE, sep = " ")



# order classes
lf_bps_scls_aoi_6$label <- factor(lf_bps_scls_aoi_6$label, 
                                        levels= c("Developed",
                                                  "Agriculture",
                                                  "UE",
                                                  "UN",
                                                  "E",
                                                  "D",
                                                  "C",
                                                  "B",
                                                  "A"))


sclassplot <-
  ggplot(lf_bps_scls_aoi_6, aes(fill = factor(ref_cur), y = percent, x = label)) + 
  geom_col(width = 0.8, position = position_dodge()) +
  coord_flip() +
  facet_grid(. ~BpS) +
  scale_x_discrete(limits = (levels(lf_bps_scls_aoi_6$label))) +
  labs(
    title = "Succession Classes past and present",
    subtitle = "6 BpSs selected for illustration. Not all succession classes present in all BpSs",
    caption = "\nData from landfire.gov. Frames are in alphabetical order. ",
    x = "",
    y = "Percent")+
  theme_minimal(base_size = 12)+
  theme(plot.caption = element_text(hjust = 0, face= "italic"), #Default is hjust=1
        plot.title.position = "plot", #NEW parameter. Apply for subtitle too.
        plot.caption.position =  "plot") +
  scale_fill_manual(values = c("#3d4740", "#32a852" ), # present (grey), historical (green)
                    name = " ", 
                    labels = c("Present",
                               "Past")) +
  facet_wrap(facets = ~model_label, 
             nrow(3),
             labeller = labeller(model_label = label_wrap_gen())) +
  theme(panel.spacing = unit(.05, "lines"),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1))

sclassplot


```







